@page
@model PyroSafe.Pages.User.AddZoneSensorModel
@{
    ViewData["Title"] = "Додати Зону та Сенсори";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Додати Зону та Сенсори</h1>

    <button type="button" class="btn-login"
            style="margin-top: 10px; background-color:#0a1a2e; border-color: #00bfff;"
            onclick="location.href='/User/Home'">
        Повернутися на головну
    </button>

    <div class="form-container">

        <!-- СТВОРЕННЯ ЗОНИ -->
        <h2>Нова зона</h2>
        <form id="zoneForm">
            <label>Назва зони:</label>
            <input type="text" id="zoneName" required />
            <label>Поверх:</label>
            <input type="number" id="floor" required />
            <label>Площа (м²):</label>
            <input type="number" step="0.1" id="area" required />
            <button type="submit" class="btn-submit">Створити Зону</button>
        </form>
        <p id="zoneResult" style="color:#00ffcc; margin:10px 0;"></p>

        <hr style="margin:20px 0; border-color:#00bfff" />

        <!-- ДОДАВАННЯ СЕНСОРІВ -->
        <h2>Додати сенсор у зону</h2>
        <label>Оберіть зону:</label>
        <select id="zoneSelect">
            <option value="">— Завантаження зон... —</option>
        </select>

        <div class="sensor-entry">
            <label>Назва сенсора:</label>
            <input type="text" id="sensorName" required />

            <label>Тип сенсора:</label>
            <select id="sensorType">
                <option value="Gas">Газ</option>
                <option value="Temperature">Температура</option>
                <option value="Smoke">Дим</option>
            </select>

            <label>Значення:</label>
            <input type="text" id="sensorValue" placeholder="наприклад: 23.5" />

            <label>Статус:</label>
            <select id="sensorStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>

            <p id="sensorResult" style="margin:10px 0; min-height:24px;"></p>

            <button type="button" id="createSensorBtn" class="btn-login">Створити сенсор</button>
        </div>
    </div>
</div>

<script>
    // Завантаження зон (camelCase!)
    async function loadZones() {
        try {
            const res = await fetch('/api/zones');  // ← правильно: /api/zones
            if (!res.ok) throw new Error('Не вдалося завантажити зони');
            const zones = await res.json();

            const select = document.getElementById('zoneSelect');
            select.innerHTML = '<option value="">— Оберіть зону —</option>';

            zones.forEach(z => {
                const opt = document.createElement('option');
                opt.value = z.id;  // ← camelCase: id
                opt.textContent = `${z.zoneName} (поверх ${z.floor})`;
                select.appendChild(opt);
            });
        } catch (err) {
            document.getElementById('zoneSelect').innerHTML = '<option value="">Помилка завантаження</option>';
        }
    }

    // Створення зони
    document.getElementById('zoneForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const zoneData = {
            zoneName: document.getElementById('zoneName').value.trim(),
            floor: parseInt(document.getElementById('floor').value),
            area: parseFloat(document.getElementById('area').value)
        };

        if (!zoneData.zoneName || isNaN(zoneData.floor) || isNaN(zoneData.area)) {
            document.getElementById('zoneResult').innerText = "Заповніть усі поля правильно!";
            return;
        }

        try {
            const response = await fetch('/api/zones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(zoneData)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Помилка сервера');
            }

            const createdZone = await response.json();
            document.getElementById('zoneResult').style.color = '#00ffcc';
            document.getElementById('zoneResult').innerText = `Зона "${createdZone.zoneName}" створена!`;

            // Очищення форми
            document.getElementById('zoneForm').reset();

            // Оновлення списку
            loadZones();
        } catch (err) {
            document.getElementById('zoneResult').style.color = '#ff5555';
            document.getElementById('zoneResult').innerText = "Помилка: " + err.message;
        }
    });

    // Створення сенсора
    document.getElementById('createSensorBtn').addEventListener('click', async () => {
        const zoneId = document.getElementById('zoneSelect').value;
        if (!zoneId) {
            document.getElementById('sensorResult').style.color = '#ffaa00';
            document.getElementById('sensorResult').innerText = "Спочатку оберіть зону!";
            return;
        }

        const sensorData = {
            sensorName: document.getElementById('sensorName').value.trim(),
            sensorValue: document.getElementById('sensorValue').value.trim() || "0",
            sensorType: document.getElementById('sensorType').value,
            status: document.getElementById('sensorStatus').value,
            zoneID: parseInt(zoneId)
        };

        if (!sensorData.sensorName) {
            document.getElementById('sensorResult').style.color = '#ffaa00';
            document.getElementById('sensorResult').innerText = "Введіть назву сенсора!";
            return;
        }

        try {
            const res = await fetch('/api/sensors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sensorData)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'Помилка створення сенсора');
            }

            document.getElementById('sensorResult').style.color = '#00ffcc';
            document.getElementById('sensorResult').innerText = "Сенсор успішно додано!";

            // Очищення полів
            document.getElementById('sensorName').value = '';
            document.getElementById('sensorValue').value = '';

        } catch (err) {
            document.getElementById('sensorResult').style.color = '#ff5555';
            document.getElementById('sensorResult').innerText = "Помилка: " + err.message;
        }
    });

    // Запуск при завантаженні
    document.addEventListener('DOMContentLoaded', loadZones);
</script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg,#0a0a0a,#0a1a2e);
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 30px;
        min-height: 100vh;
    }

    .form-wrapper {
        text-align: center;
        width: 520px;
    }

    .form-container {
        background-color: #0d0d0d;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,191,255,0.5);
    }

    h2 {
        color: #00bfff;
        margin-top: 25px;
    }

    label {
        display: block;
        margin-top: 12px;
        color: #00bfff;
        text-align: left;
    }

    input, select {
        width: 100%;
        padding: 10px;
        margin: 8px 0 16px;
        border-radius: 6px;
        border: 1px solid #00bfff;
        background: #0a0a0a;
        color: #fff;
        font-size: 16px;
    }

    .btn-submit, .btn-login {
        padding: 12px;
        width: 100%;
        margin-top: 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s;
    }

    .btn-submit {
        background: #00bfff;
        color: #0a0a0a;
    }

        .btn-submit:hover {
            background: #00ffff;
        }

    .btn-login {
        background: #0a0a0a;
        border: 2px solid #00bfff;
        color: #00bfff;
    }

        .btn-login:hover {
            background: #00bfff;
            color: #0a0a0a;
        }

    .sensor-entry {
        border: 1px solid #00bfff;
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
        background: rgba(0,191,255,0.05);
    }
</style>