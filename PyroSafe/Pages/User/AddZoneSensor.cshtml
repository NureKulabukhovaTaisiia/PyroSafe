@page
@model PyroSafe.Pages.User.AddZoneSensorModel
@{
    ViewData["Title"] = "Додати / Видалити Зони та Сенсори";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Керування Зонами та Сенсорами</h1>

    <button type="button" class="btn-login"
            style="margin-top: 10px; background-color:#0a1a2e; border-color: #00bfff;"
            onclick="location.href='/User/Home'">
        Повернутися на головну
    </button>

    <div class="form-container">

        <!-- =================== СТВОРЕННЯ ЗОНИ =================== -->
        <h2>Нова зона</h2>
        <form id="zoneForm">
            <label>Назва зони:</label>
            <input type="text" id="zoneName" required placeholder="Наприклад: Кухня" />

            <label>Поверх:</label>
            <input type="number" id="floor" required min="1" />

            <label>Площа (м²):</label>
            <input type="number" step="0.1" id="area" required min="1" />

            <button type="submit" class="btn-submit">Створити Зону</button>
        </form>
        <p id="zoneResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>

        <hr style="margin:30px 0; border-color:#00bfff" />

        <!-- =================== ДОДАВАННЯ СЕНСОРА =================== -->
        <h2>Додати сенсор у зону</h2>
        <label>Оберіть зону:</label>
        <select id="zoneSelectAdd">
            <option value="">— Завантаження зон... —</option>
        </select>

        <div class="sensor-entry">
            <label>Назва сенсора:</label>
            <input type="text" id="sensorName" required placeholder="Напр.: Датчик диму №1" />

            <label>Тип сенсора:</label>
            <select id="sensorType">
                <option value="Gas">Газ</option>
                <option value="Temperature">Температура</option>
                <option value="Smoke">Дим</option>
            </select>

            <label>Значення (опціонально):</label>
            <input type="text" id="sensorValue" placeholder="наприклад: 23.5" />

            <label>Статус:</label>
            <select id="sensorStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>

            <p id="sensorResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>
            <button type="button" id="createSensorBtn" class="btn-login">Створити сенсор</button>
        </div>

        <hr style="margin:30px 0; border-color:#00bfff" />

        <!-- =================== ВИДАЛЕННЯ ЗОНИ =================== -->
        <h2 style="color:#ff5555;">Видалити зону</h2>
        <label>Оберіть зону для видалення:</label>
        <select id="zoneSelectDelete">
            <option value="">— Оберіть зону —</option>
        </select>
        <p id="deleteZoneResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>
        <button type="button" id="deleteZoneBtn" class="btn-delete">Видалити зону</button>

        <hr style="margin:30px 0; border-color:#00bfff" />

        <!-- =================== ВИДАЛЕННЯ СЕНСОРА =================== -->
        <h2 style="color:#ff5555;">Видалити сенсор</h2>
        <label>Оберіть зону:</label>
        <select id="zoneSelectForSensorDelete">
            <option value="">— Спочатку оберіть зону —</option>
        </select>

        <label>Оберіть сенсор:</label>
        <select id="sensorSelectDelete">
            <option value="">— Спочатку оберіть зону —</option>
        </select>

        <p id="deleteSensorResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>
        <button type="button" id="deleteSensorBtn" class="btn-delete">Видалити сенсор</button>
    </div>
</div>

<script>
    // Загальне завантаження зон
    async function loadZones(selectId = 'zoneSelectAdd') {
        try {
            const res = await fetch('/api/zones');
            if (!res.ok) throw new Error('Не вдалося завантажити зони');
            const zones = await res.json();

            // Оновлюємо всі селекти зон
            ['zoneSelectAdd', 'zoneSelectDelete', 'zoneSelectForSensorDelete'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">— Оберіть зону —</option>';
                    zones.forEach(z => {
                        const opt = document.createElement('option');
                        opt.value = z.id;
                        opt.textContent = `${z.zoneName} (поверх ${z.floor})`;
                        select.appendChild(opt);
                    });
                }
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Завантаження сенсорів для видалення
    async function loadSensorsForZone(zoneId) {
        const select = document.getElementById('sensorSelectDelete');
        select.innerHTML = '<option value="">— Завантаження сенсорів... —</option>';

        if (!zoneId) {
            select.innerHTML = '<option value="">— Спочатку оберіть зону —</option>';
            return;
        }

        try {
            const res = await fetch('/api/sensors');
            if (!res.ok) throw new Error('Не вдалося завантажити сенсори');
            const sensors = await res.json();

            const zoneSensors = sensors.filter(s => s.zoneID === parseInt(zoneId));
            select.innerHTML = '<option value="">— Оберіть сенсор —</option>';

            if (zoneSensors.length === 0) {
                select.innerHTML = '<option value="">Немає сенсорів у цій зоні</option>';
                return;
            }

            zoneSensors.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.sensorName} (${s.sensorType}, ${s.status})`;
                select.appendChild(opt);
            });
        } catch (err) {
            select.innerHTML = '<option value="">Помилка завантаження</option>';
        }
    }

    // === Створення зони ===
    document.getElementById('zoneForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const zoneData = {
            zoneName: document.getElementById('zoneName').value.trim(),
            floor: parseInt(document.getElementById('floor').value),
            area: parseFloat(document.getElementById('area').value)
        };

        if (!zoneData.zoneName || isNaN(zoneData.floor) || isNaN(zoneData.area)) {
            document.getElementById('zoneResult').style.color = '#ffaa00';
            document.getElementById('zoneResult').innerText = "Заповніть усі поля!";
            return;
        }

        try {
            const res = await fetch('/api/zones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(zoneData)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'Не вдалося створити зону');
            }

            document.getElementById('zoneResult').style.color = '#00ffcc';
            document.getElementById('zoneResult').innerText = `Зона "${zoneData.zoneName}" створена!`;
            document.getElementById('zoneForm').reset();
            loadZones();
        } catch (err) {
            document.getElementById('zoneResult').style.color = '#ff5555';
            document.getElementById('zoneResult').innerText = "Помилка: " + err.message;
        }
    });

    // === Створення сенсора ===
    document.getElementById('createSensorBtn').addEventListener('click', async () => {
        const zoneId = document.getElementById('zoneSelectAdd').value;
        if (!zoneId) return showError('sensorResult', "Оберіть зону!");

        const sensorData = {
            sensorName: document.getElementById('sensorName').value.trim(),
            sensorValue: document.getElementById('sensorValue').value.trim() || "0",
            sensorType: document.getElementById('sensorType').value,
            status: document.getElementById('sensorStatus').value,
            zoneID: parseInt(zoneId)
        };

        if (!sensorData.sensorName) return showError('sensorResult', "Введіть назву сенсора!");

        try {
            const res = await fetch('/api/sensors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sensorData)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'Помилка створення');
            }

            document.getElementById('sensorResult').style.color = '#00ffcc';
            document.getElementById('sensorResult').innerText = "Сенсор додано!";
            document.getElementById('sensorName').value = '';
            document.getElementById('sensorValue').value = '';
        } catch (err) {
            showError('sensorResult', err.message);
        }
    });

    // === Видалення зони ===
    document.getElementById('deleteZoneBtn').addEventListener('click', async () => {
        const zoneId = document.getElementById('zoneSelectDelete').value;
        if (!zoneId) return showError('deleteZoneResult', "Оберіть зону!");

        if (!confirm("УВАГА! Видалити всю зону та всі її сенсори?")) return;

        try {
            const res = await fetch(`/api/zones/${zoneId}`, { method: 'DELETE' });
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'Не вдалося видалити');
            }

            document.getElementById('deleteZoneResult').style.color = '#00ffcc';
            document.getElementById('deleteZoneResult').innerText = "Зона успішно видалена!";
            loadZones();
            loadSensorsForZone(document.getElementById('zoneSelectForSensorDelete').value);
        } catch (err) {
            showError('deleteZoneResult', err.message);
        }
    });

    // === Видалення сенсора ===
    document.getElementById('deleteSensorBtn').addEventListener('click', async () => {
        const sensorId = document.getElementById('sensorSelectDelete').value;
        if (!sensorId) return showError('deleteSensorResult', "Оберіть сенсор!");

        if (!confirm("Видалити цей сенсор?")) return;

        try {
            const res = await fetch(`/api/sensors/${sensorId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Не вдалося видалити сенсор');

            document.getElementById('deleteSensorResult').style.color = '#00ffcc';
            document.getElementById('deleteSensorResult').innerText = "Сенсор видалено!";
            const zoneId = document.getElementById('zoneSelectForSensorDelete').value;
            loadSensorsForZone(zoneId);
        } catch (err) {
            showError('deleteSensorResult', err.message);
        }
    });

    // Реакція на вибір зони для видалення сенсора
    document.getElementById('zoneSelectForSensorDelete').addEventListener('change', (e) => {
        loadSensorsForZone(e.target.value);
    });

    // Допоміжна функція
    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        el.style.color = '#ff5555';
        el.innerText = message;
    }

    // Запуск
    document.addEventListener('DOMContentLoaded', () => {
        loadZones();
    });
</script>

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg,#0a0a0a,#0a1a2e);
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 30px;
        min-height: 100vh;
    }

    .form-wrapper {
        text-align: center;
        width: 560px;
    }

    .form-container {
        background-color: #0d0d0d;
        padding: 35px;
        border-radius: 16px;
        box-shadow: 0 0 25px rgba(0,191,255,0.6);
    }

    h2 {
        color: #00bfff;
        margin: 30px 0 20px;
    }

        h2[style*="ff5555"] {
            color: #ff5555 !important;
        }

    label {
        display: block;
        margin-top: 14px;
        color: #00bfff;
        text-align: left;
        font-weight: 600;
    }

    input, select {
        width: 100%;
        padding: 12px;
        margin: 8px 0 16px;
        border-radius: 8px;
        border: 1px solid #00bfff;
        background: #0a0a0a;
        color: #fff;
        font-size: 16px;
    }

    .btn-submit, .btn-login, .btn-delete {
        padding: 14px;
        width: 100%;
        margin-top: 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s;
    }

    .btn-submit {
        background: #00bfff;
        color: #0a0a0a;
    }

        .btn-submit:hover {
            background: #00ffff;
        }

    .btn-login {
        background: #0a0a0a;
        border: 2px solid #00bfff;
        color: #00bfff;
    }

        .btn-login:hover {
            background: #00bfff;
            color: #0a0a0a;
        }

    .btn-delete {
        background: #ff3333;
        color: white;
    }

        .btn-delete:hover {
            background: #ff5555;
        }

    .sensor-entry {
        border: 1px solid #00bfff;
        padding: 20px;
        margin: 20px 0;
        border-radius: 12px;
        background: rgba(0,191,255,0.05);
    }
</style>