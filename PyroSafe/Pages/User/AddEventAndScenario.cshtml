@page
@model PyroSafe.Pages.User.AddEventAndScenarioModel
@{
    ViewData["Title"] = "Сценарії та Івенти";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Сценарії та Івенти</h1>
    <button type="button" class="btn-login" onclick="location.href='/User/Home'">На головну</button>

    <div class="form-container">

        <!-- СТВОРИТИ СЦЕНАРІЙ -->
        <h2 style="color:#00ffcc;">Створити сценарій</h2>
        <div class="entry-box">
            <input type="text" id="scenarioType" placeholder="Тип (наприклад: Пожежа)" />
            <input type="text" id="scenarioDesc" placeholder="Опис (не обов’язково)" />
            <select id="scenarioPriority">
                <option value="Low">Низький</option>
                <option value="Medium">Середній</option>
                <option value="High">Високий</option>
                <option value="Critical">Критичний</option>
            </select>
            <label><input type="checkbox" id="scenarioActive" checked /> Активний</label>
            <button id="createScenarioBtn" class="btn-submit">Створити сценарій</button>
            <p id="scenarioResult"></p>
        </div>

        <hr />

        <h2>Сценарії</h2>
        <div id="scenariosList" class="items-container">Завантаження...</div>

        <hr />

        <!-- ЗАРЕЄСТРУВАТИ ІВЕНТ -->
        <h2 style="color:#ffaa00;">Зареєструвати івент</h2>
        <div class="entry-box">
            <select id="eventSensorSelect"><option>— Оберіть сенсор —</option></select>
            <select id="eventScenarioSelect"><option value="">— Без сценарію —</option></select>
            <input type="text" id="eventDesc" placeholder="Опис івенту" required />
            <select id="eventSeverity">
                <option value="Info">Інформація</option>
                <option value="Warning">Попередження</option>
                <option value="Critical">Критична</option>
            </select>
            <select id="eventStatus">
                <option value="Active">Активний</option>
                <option value="Resolved">Вирішений</option>
            </select>
            <button id="createEventBtn" class="btn-submit">Зареєструвати івент</button>
            <p id="eventResult"></p>
        </div>

        <hr />

        <h2>Останні івенти</h2>
        <div id="eventsList" class="items-container">Завантаження...</div>
    </div>
</div>

<script>
    async function safeJson(res) {
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
        }
        const text = await res.text();
        if (!text) return null;
        try { return JSON.parse(text); }
        catch { throw new Error("Некоректний JSON від сервера"); }
    }

    async function loadAllData() {
        await Promise.allSettled([
            loadScenarios(),
            loadEvents(),
            loadSensorsAndScenariosForSelects()
        ]);
    }

    async function loadScenarios() {
        try {
            const data = await (await fetch('/api/scenarios')).json();
            const list = document.getElementById('scenariosList');
            if (!data?.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;">Немає сценаріїв</p>';
                return;
            }
            list.innerHTML = data.map(s => `
                <div class="item-card ${s.isActive ? 'active' : 'inactive'}">
                    <div class="item-header">
                        <strong>${s.scenarioType}</strong>
                        <span class="priority-badge priority-${s.priority.toLowerCase()}">${s.priority}</span>
                        <span class="status-dot ${s.isActive ? 'active' : 'inactive'}"></span>
                    </div>
                    <p class="description">${s.description || 'Без опису'}</p>
                    <button class="btn-delete" onclick="deleteScenario(${s.id})">Видалити</button>
                </div>
            `).join('');
        } catch (err) {
            document.getElementById('scenariosList').innerHTML = `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

    async function loadEvents() {
        try {
            const data = await (await fetch('/api/events')).json();
            const list = document.getElementById('eventsList');
            if (!data?.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;">Немає івентів</p>';
                return;
            }

            list.innerHTML = data.map(e => {
                const date = e.createdAt ? new Date(e.createdAt).toLocaleString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '—';
                const creator = e.createdByName ? `Охоронець #${e.createdBy}` : `ID ${e.createdBy || '?'}`;
                const severityClass = e.severity.toLowerCase();

                return `
                    <div class="item-card severity-${severityClass} ${e.status === 'Resolved' ? 'resolved' : ''}">
                        <div class="item-header">
                            <strong>Івент #${e.id}</strong>
                            <span class="severity-badge">${e.severity}</span>
                            <span class="status-dot ${e.status === 'Resolved' ? 'active' : 'inactive'}"></span>
                        </div>
                        <p><strong>Сенсор:</strong> ${e.sensorName || e.sensorID} | <strong>Сценарій:</strong> ${e.scenarioName || e.scenarioID || '—'}</p>
                        <p class="description">${e.description || 'Без опису'}</p>
                        <div class="event-meta">
                            <small>Створено: ${date}</small><br>
                            <small>Автор: ${creator}</small>
                        </div>
                        <button class="btn-delete" onclick="deleteEvent(${e.id})">Видалити</button>
                    </div>
                `;
            }).join('');
        } catch (err) {
            document.getElementById('eventsList').innerHTML = `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

    async function loadSensorsAndScenariosForSelects() {
        try {
            const [sensorsRes, scenariosRes] = await Promise.all([
                fetch('/api/sensors'), fetch('/api/scenarios')
            ]);
            const sensors = await safeJson(sensorsRes) || [];
            const scenarios = await safeJson(scenariosRes) || [];

            const sensorSelect = document.getElementById('eventSensorSelect');
            sensorSelect.innerHTML = '<option value="">— Оберіть сенсор —</option>';
            sensors.forEach(s => sensorSelect.add(new Option(`${s.sensorName} (${s.sensorType})`, s.id)));

            const scenarioSelect = document.getElementById('eventScenarioSelect');
            scenarioSelect.innerHTML = '<option value="">— Без сценарію —</option>';
            scenarios.forEach(s => scenarioSelect.add(new Option(`${s.scenarioType}`, s.id)));
        } catch (err) {
            console.error("Помилка селектів:", err);
        }
    }

    // === СТВОРЕННЯ СЦЕНАРІЮ ===
    document.getElementById('createScenarioBtn').onclick = async () => {
        const data = {
            scenarioType: document.getElementById('scenarioType').value.trim(),
            description: document.getElementById('scenarioDesc').value.trim(),
            priority: document.getElementById('scenarioPriority').value,
            isActive: document.getElementById('scenarioActive').checked
        };
        if (!data.scenarioType) return showMsg('scenarioResult', 'Введіть тип!', '#ffaa00');

        try {
            await fetch('/api/scenarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showMsg('scenarioResult', 'Сценарій створено!', '#00ffcc');
            document.getElementById('scenarioType').value = '';
            loadAllData();
        } catch (err) {
            showMsg('scenarioResult', err.message, '#ff5555');
        }
    };

    // === СТВОРЕННЯ ІВЕНТУ ===
    document.getElementById('createEventBtn').onclick = async () => {
        const data = {
            sensorID: +document.getElementById('eventSensorSelect').value,
            scenarioID: document.getElementById('eventScenarioSelect').value ? +document.getElementById('eventScenarioSelect').value : null,
            description: document.getElementById('eventDesc').value.trim(),
            severity: document.getElementById('eventSeverity').value,
            status: document.getElementById('eventStatus').value
        };

        if (!data.sensorID || !data.description) {
            return showMsg('eventResult', 'Заповніть сенсор та опис!', '#ffaa00');
        }

        try {
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Не вдалося створити івент');
            showMsg('eventResult', 'Івент зареєстровано!', '#00ffcc');
            document.getElementById('eventDesc').value = '';
            loadEvents();
        } catch (err) {
            showMsg('eventResult', err.message, '#ff5555');
        }
    };

    // Видалення
    window.deleteScenario = id => confirm('Видалити сценарій?') && fetch(`/api/scenarios/${id}`, { method: 'DELETE' }).then(() => loadAllData());
    window.deleteEvent = id => confirm('Видалити івент?') && fetch(`/api/events/${id}`, { method: 'DELETE' }).then(() => loadEvents());

    function showMsg(id, text, color) {
        const el = document.getElementById(id);
        el.innerHTML = text;
        el.style.color = color;
        setTimeout(() => el.innerHTML = '', 5000);
    }

    // Автовибір сенсора з URL
    const urlParams = new URLSearchParams(location.search);
    const sensorId = urlParams.get('sensorId');
    if (sensorId) setTimeout(() => document.getElementById('eventSensorSelect').value = sensorId, 1000);

    document.addEventListener('DOMContentLoaded', loadAllData);
</script>

<style>
    .event-meta {
        margin-top: 10px;
        font-size: 13px;
        color: #88dddd;
    }

        .event-meta small {
            display: block;
            margin: 4px 0;
        }

    .severity-info {
        border-left-color: #00ffff;
    }

    .severity-warning {
        border-left-color: #ffaa00;
    }

    .severity-critical {
        border-left-color: #ff0066;
    }

    .resolved {
        opacity: 0.8;
        border-left-color: #00ff00 !important;
    }

    .severity-badge {
        background: rgba(255,255,255,0.15);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
    }

    .description {
        margin: 8px 0;
        color: #ccc;
    }

    .item-card {
        position: relative;
        transition: all 0.3s;
    }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 25px rgba(0,191,255,0.5);
        }

    .btn-delete:hover {
        background: #ff5555;
    }

    @@keyframes pulse-green {
        0%, 100% {
            box-shadow: 0 0 15px #00ff0088;
        }

        50% {
            box-shadow: 0 0 35px #00ff00ee;
            transform: scale(1.3);
        }
    }

    @@keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 15px #ff000088;
        }

        50% {
            box-shadow: 0 0 35px #ff0000ee;
            transform: scale(1.3);
        }
    }
</style>