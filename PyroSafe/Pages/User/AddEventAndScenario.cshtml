@page
@model PyroSafe.Pages.User.AddEventAndScenarioModel
@{
    ViewData["Title"] = "Сценарії та Івенти";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Сценарії та Івенти</h1>
    <button type="button" class="btn-login" onclick="location.href='/User/Home'">На головну</button>

    <div class="form-container">

        <!-- СТВОРИТИ СЦЕНАРІЙ -->
        <h2 style="color:#00ffcc;">Створити сценарій</h2>
        <div class="entry-box">
            <input type="text" id="scenarioType" placeholder="Тип (наприклад: Пожежа)" />
            <input type="text" id="scenarioDesc" placeholder="Опис (не обов’язково)" />
            <select id="scenarioPriority">
                <option value="Low">Низький</option>
                <option value="Medium">Середній</option>
                <option value="High">Високий</option>
                <option value="Critical">Критичний</option>
            </select>
            <label><input type="checkbox" id="scenarioActive" checked /> Активний</label>
            <button id="createScenarioBtn" class="btn-submit">Створити сценарій</button>
            <p id="scenarioResult"></p>
        </div>

        <hr />

        <h2>Сценарії</h2>
        <div id="scenariosList" class="items-container">Завантаження...</div>

        <hr />

        <!-- ЗАРЕЄСТРУВАТИ ІВЕНТ -->
        <h2 style="color:#ffaa00;">Зареєструвати івент</h2>
        <div class="entry-box">
            <select id="eventSensorSelect"><option>— Оберіть сенсор —</option></select>
            <select id="eventScenarioSelect"><option value="">— Без сценарію —</option></select>
            <input type="text" id="eventDesc" placeholder="Опис івенту" required />
            <select id="eventSeverity">
                <option value="Info">Інформація</option>
                <option value="Warning">Попередження</option>
                <option value="Critical">Критична</option>
            </select>
            <select id="eventStatus">
                <option value="Active">Активний</option>
                <option value="Resolved">Вирішений</option>
            </select>
            <button id="createEventBtn" class="btn-submit">Зареєструвати івент</button>
            <p id="eventResult"></p>
        </div>

        <hr />

        <h2>Останні івенти</h2>
        <div id="eventsList" class="items-container">Завантаження...</div>
    </div>
</div>

<script>
    async function safeJson(res) {
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text || res.statusText}`);
        }
        const text = await res.text();
        if (!text) return null;
        try { return JSON.parse(text); }
        catch { throw new Error("Некоректний JSON від сервера"); }
    }

    async function loadAllData() {
        await Promise.allSettled([
            loadScenarios(),
            loadEvents(),
            loadSensorsAndScenariosForSelects()
        ]);
    }

    async function loadScenarios() {
        try {
            const data = await (await fetch('/api/scenarios')).json();
            const list = document.getElementById('scenariosList');
            if (!data?.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;">Немає сценаріїв</p>';
                return;
            }
            list.innerHTML = data.map(s => `
                <div class="item-card ${s.isActive ? 'active' : 'inactive'}">
                    <div class="item-header">
                        <strong>${s.scenarioType}</strong>
                        <span class="priority-badge priority-${s.priority.toLowerCase()}">${s.priority}</span>
                        <span class="status-dot ${s.isActive ? 'active' : 'inactive'}"></span>
                    </div>
                    <p class="description">${s.description || 'Без опису'}</p>
                    <button class="btn-delete" onclick="deleteScenario(${s.id})">Видалити</button>
                </div>
            `).join('');
        } catch (err) {
            document.getElementById('scenariosList').innerHTML = `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

      async function loadEvents() {
        try {
            const data = await (await fetch('/api/events')).json();
            const list = document.getElementById('eventsList');
            if (!data?.length) {
                list.innerHTML = '<p style="color:#888;text-align:center;">Немає івентів</p>';
                return;
            }

            list.innerHTML = data.map(e => {
                const date = new Date(e.createdAt).toLocaleString('uk-UA', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                const severityClass = (e.severity || 'info').toLowerCase();
                const isResolved = e.status === 'Resolved';

                return `
                    <div class="item-card severity-${severityClass} ${isResolved ? 'resolved' : ''}">
                        <div class="item-header">
                            <strong>Івент #${e.id}</strong>
                            <span class="severity-badge">${e.severity || 'Info'}</span>
                            <span class="status-dot ${isResolved ? 'active' : 'inactive'}"></span>
                        </div>
                        <p><strong>Сенсор:</strong> ${e.sensorName || 'Невідомий'} |
                           <strong>Сценарій:</strong> ${e.scenarioName || '—'}</p>
                        <p class="description">${e.description || 'Без опису'}</p>
                        <div class="event-meta">
                            <small>Створено: ${date}</small><br>
                            <small>Автор: ${e.createdByName || 'Охоронець'} #${e.createdBy}</small>
                        </div>
                        <button class="btn-delete" onclick="deleteEvent(${e.id})">Видалити</button>
                    </div>
                `;
            }).join('');

            // Додаємо звукову сирену для Critical івентів (бонус!)
            if (data.some(e => e.severity === 'Critical' && e.status !== 'Resolved')) {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-tone-1065.mp3');
                audio.play().catch(() => {});
            }

        } catch (err) {
            document.getElementById('eventsList').innerHTML =
                `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

    async function loadSensorsAndScenariosForSelects() {
        try {
            const [sensorsRes, scenariosRes] = await Promise.all([
                fetch('/api/sensors'), fetch('/api/scenarios')
            ]);
            const sensors = await safeJson(sensorsRes) || [];
            const scenarios = await safeJson(scenariosRes) || [];

            const sensorSelect = document.getElementById('eventSensorSelect');
            sensorSelect.innerHTML = '<option value="">— Оберіть сенсор —</option>';
            sensors.forEach(s => sensorSelect.add(new Option(`${s.sensorName} (${s.sensorType})`, s.id)));

            const scenarioSelect = document.getElementById('eventScenarioSelect');
            scenarioSelect.innerHTML = '<option value="">— Без сценарію —</option>';
            scenarios.forEach(s => scenarioSelect.add(new Option(`${s.scenarioType}`, s.id)));
        } catch (err) {
            console.error("Помилка селектів:", err);
        }
    }

    // === СТВОРЕННЯ СЦЕНАРІЮ ===
    document.getElementById('createScenarioBtn').onclick = async () => {
        const data = {
            scenarioType: document.getElementById('scenarioType').value.trim(),
            description: document.getElementById('scenarioDesc').value.trim(),
            priority: document.getElementById('scenarioPriority').value,
            isActive: document.getElementById('scenarioActive').checked
        };
        if (!data.scenarioType) return showMsg('scenarioResult', 'Введіть тип!', '#ffaa00');

        try {
            await fetch('/api/scenarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showMsg('scenarioResult', 'Сценарій створено!', '#00ffcc');
            document.getElementById('scenarioType').value = '';
            loadAllData();
        } catch (err) {
            showMsg('scenarioResult', err.message, '#ff5555');
        }
    };

    // === СТВОРЕННЯ ІВЕНТУ ===
    document.getElementById('createEventBtn').onclick = async () => {
        const data = {
            sensorID: +document.getElementById('eventSensorSelect').value,
            scenarioID: document.getElementById('eventScenarioSelect').value ? +document.getElementById('eventScenarioSelect').value : null,
            description: document.getElementById('eventDesc').value.trim(),
            severity: document.getElementById('eventSeverity').value,
            status: document.getElementById('eventStatus').value
        };

        if (!data.sensorID || !data.description) {
            return showMsg('eventResult', 'Заповніть сенсор та опис!', '#ffaa00');
        }

        try {
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Не вдалося створити івент');
            showMsg('eventResult', 'Івент зареєстровано!', '#00ffcc');
            document.getElementById('eventDesc').value = '';
            loadEvents();
        } catch (err) {
            showMsg('eventResult', err.message, '#ff5555');
        }
    };

    // Видалення
    window.deleteScenario = id => confirm('Видалити сценарій?') && fetch(`/api/scenarios/${id}`, { method: 'DELETE' }).then(() => loadAllData());
    window.deleteEvent = id => confirm('Видалити івент?') && fetch(`/api/events/${id}`, { method: 'DELETE' }).then(() => loadEvents());

    function showMsg(id, text, color) {
        const el = document.getElementById(id);
        el.innerHTML = text;
        el.style.color = color;
        setTimeout(() => el.innerHTML = '', 5000);
    }

    // Автовибір сенсора з URL
    const urlParams = new URLSearchParams(location.search);
    const sensorId = urlParams.get('sensorId');
    if (sensorId) setTimeout(() => document.getElementById('eventSensorSelect').value = sensorId, 1000);

    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
<style>
    /* БАЗОВИЙ СТИЛЬ КАРТКИ */
    .item-card {
        background: rgba(10, 25, 49, 0.7);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        border-left: 6px solid;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        transition: all 0.4s ease;
        position: relative;
    }

        .item-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 0 30px rgba(0, 191, 255, 0.7);
        }

    /* КОЛЬОРИ ЗА ТЯЖКІСТЮ */
    .severity-info {
        border-left-color: #00ffff;
        background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
    }

    .severity-warning {
        border-left-color: #ffaa00;
        background: linear-gradient(90deg, rgba(255, 170, 0, 0.15), transparent);
    }

    .severity-critical {
        border-left-color: #ff0066;
        background: linear-gradient(90deg, rgba(255, 0, 102, 0.2), transparent);
        animation: pulse-red 2s infinite;
    }

    .resolved {
        opacity: 0.7;
        border-left-color: #00ff88 !important;
        background: linear-gradient(90deg, rgba(0, 255, 136, 0.15), transparent) !important;
    }

    /* ЗАГОЛОВОК КАРТКИ */
    .item-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

        .item-header strong {
            font-size: 1.2em;
            color: #00ffff;
        }

    .severity-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ff5555;
        display: inline-block;
    }

        .status-dot.active {
            background: #00ff88;
            box-shadow: 0 0 15px #00ff88;
            animation: pulse-green 2s infinite;
        }

        .status-dot.inactive {
            background: #666;
        }

    /* ОПИС ТА МЕТА */
    .description {
        margin: 10px 0;
        color: #cccccc;
        font-style: italic;
    }

    .event-meta {
        margin-top: 12px;
        font-size: 0.9em;
        color: #88dddd;
    }

        .event-meta small {
            display: block;
            margin: 3px 0;
        }

    /* КНОПКА ВИДАЛЕННЯ */
    .btn-delete {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 85, 85, 0.2);
        border: 1px solid #ff5555;
        color: #ff8888;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.3s;
    }

        .btn-delete:hover {
            background: #ff5555;
            color: white;
            transform: scale(1.1);
        }

    /* АНІМАЦІЇ */
    @@keyframes pulse-green {
        0%, 100%

    {
        box-shadow: 0 0 15px #00ff0088;
    }

    50% {
        box-shadow: 0 0 35px #00ff00ee;
    }

    }

    @@keyframes pulse-red {
        0%, 100%

    {
        box-shadow: 0 0 15px #ff000088;
    }

    50% {
        box-shadow: 0 0 35px #ff0000ee;
    }

    }

    /* АКТИВНІ/НЕАКТИВНІ СЦЕНАРІЇ */
    .active {
        border-left-color: #00ff88;
    }

    .inactive {
        border-left-color: #666;
        opacity: 0.6;
    }

    .priority-badge {
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.8em;
        margin-left: 8px;
    }

    .priority-low {
        background: #444;
    }

    .priority-medium {
        background: #0066cc;
    }

    .priority-high {
        background: #ffaa00;
        color: black;
    }

    .priority-critical {
        background: #ff0066;
        color: white;
        animation: pulse-red 3s infinite;
    }
</style>