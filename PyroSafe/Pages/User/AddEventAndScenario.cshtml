@page
@model PyroSafe.Pages.User.AddEventAndScenarioModel
@{
    ViewData["Title"] = "Сценарії та Івенти";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Сценарії та Івенти</h1>

    <button type="button" class="btn-login" onclick="location.href='/User/Home'">
        На головну
    </button>

    <div class="form-container">

        <!-- СТВОРИТИ СЦЕНАРІЙ -->
        <h2 style="color:#00ffcc;">Створити сценарій</h2>
        <div class="entry-box">
            <input type="text" id="scenarioType" placeholder="Тип (наприклад: Пожежа)" required />
            <input type="text" id="scenarioDesc" placeholder="Опис (опціонально)" />
            <select id="scenarioPriority">
                <option value="Low">Низький</option>
                <option value="Medium">Середній</option>
                <option value="High">Високий</option>
                <option value="Critical">Критичний</option>
            </select>
            <label><input type="checkbox" id="scenarioActive" checked /> Активний</label>
            <button id="createScenarioBtn" class="btn-submit">Створити сценарій</button>
            <p id="scenarioResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>
        </div>

        <hr />

        <!-- СПИСОК СЦЕНАРІЇВ -->
        <h2>Сценарії</h2>
        <div id="scenariosList" class="items-container">
            <p style="text-align:center; color:#00bfff;">Завантаження сценаріїв...</p>
        </div>

        <hr />

        <!-- СТВОРИТИ ІВЕНТ -->
        <h2 style="color:#ffaa00;">Зареєструвати івент</h2>
        <div class="entry-box">
            <select id="eventSensorSelect"><option>— Оберіть сенсор —</option></select>
            <select id="eventScenarioSelect"><option value="">— Без сценарію —</option></select>
            <input type="text" id="eventDesc" placeholder="Опис івенту" required />
            <select id="eventSeverity">
                <option value="Info">Інформація</option>
                <option value="Warning">Попередження</option>
                <option value="Critical">Критична</option>
            </select>
            <select id="eventStatus">
                <option value="Active">Активний</option>
                <option value="Resolved">Вирішений</option>
            </select>
            <button id="createEventBtn" class="btn-submit">Зареєструвати івент</button>
            <p id="eventResult" style="margin:10px 0; min-height:24px; font-weight:bold;"></p>
        </div>

        <hr />

        <!-- ФІЛЬТР ТА СПИСОК ІВЕНТІВ -->
        <div style="margin-bottom: 15px; text-align: right;">
            <label>
                <input type="checkbox" id="showResolved" checked onchange="loadEvents()" />
                Показувати вирішені
            </label>
        </div>

        <h2>Останні івенти</h2>
        <div id="eventsList" class="items-container">
            <p style="text-align:center; color:#00bfff;">Завантаження івентів...</p>
        </div>
    </div>
</div>

<script>
    async function loadAllData() {
        await Promise.all([
            loadScenarios(),
            loadEvents(),
            loadSensorsAndScenariosForSelects()
        ]);
    }

    // === Сценарії ===
    async function loadScenarios() {
        try {
            const res = await fetch('/api/scenarios');
            if (!res.ok) throw new Error('Не вдалося завантажити сценарії');
            const scenarios = await res.json();

            const list = document.getElementById('scenariosList');
            if (scenarios.length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center;">Немає створених сценаріїв</p>';
                return;
            }

            list.innerHTML = scenarios.map(s => `
                <div class="item-card ${s.isActive ? 'active' : 'inactive'}">
                    <div class="item-header">
                        <strong>${s.scenarioType}</strong>
                        <span class="priority-badge priority-${s.priority.toLowerCase()}">${s.priority}</span>
                        <span class="status-dot ${s.isActive ? 'active' : 'inactive'}"></span>
                    </div>
                    <p class="description">${s.description || 'Без опису'}</p>
                    <div class="item-actions">
                        <button class="btn-delete" onclick="deleteScenario(${s.id})">Видалити</button>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            document.getElementById('scenariosList').innerHTML = '<p style="color:#ff5555; text-align:center;">Помилка завантаження сценаріїв</p>';
        }
    }

    // === Івенти ===
    async function loadEvents() {
        try {
            const res = await fetch('/api/events');
            if (!res.ok) throw new Error('Не вдалося завантажити івенти');
            const events = await res.json();

            const showResolved = document.getElementById('showResolved').checked;
            const filtered = showResolved ? events : events.filter(e => e.status !== 'Resolved');

            const list = document.getElementById('eventsList');
            if (filtered.length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center;">Немає івентів</p>';
                return;
            }

            list.innerHTML = filtered.map(e => `
                <div class="item-card severity-${(e.severity || 'info').toLowerCase()} ${e.status === 'Resolved' ? 'resolved' : ''}">
                    <div class="item-header">
                        <strong>Івент #${e.id}</strong>
                        <span class="severity-badge">${e.severity || 'Info'}</span>
                        <span class="status-dot ${e.status === 'Resolved' ? 'active' : 'inactive'}"></span>
                    </div>
                    <p><strong>Сенсор:</strong> ${e.sensorName || 'Невідомий'}</p>
                    <p><strong>Сценарій:</strong> ${e.scenarioName || '—'}</p>
                    <p class="description">${e.description || 'Без опису'}</p>
                    ${e.resolvedAt ? `
                        <small style="color:#00ff00;">
                            Вирішено: ${new Date(e.resolvedAt).toLocaleString()}
                            ${e.resolvedByName ? ` — ${e.resolvedByName}` : ''}
                        </small>
                    ` : '<small style="color:#ffaa00;">Активний</small>'}
                    <div class="item-actions">
                        ${e.status !== 'Resolved' ? `
                            <button class="btn-resolve" onclick="resolveEvent(${e.id})">Вирішити</button>
                        ` : ''}
                        <button class="btn-delete" onclick="deleteEvent(${e.id})">Видалити</button>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            console.error(err);
            document.getElementById('eventsList').innerHTML = '<p style="color:#ff5555; text-align:center;">Помилка завантаження івентів</p>';
        }
    }

    // === Сенсори та сценарії у селекти ===
    async function loadSensorsAndScenariosForSelects() {
        try {
            const [sensorsRes, scenariosRes] = await Promise.all([
                fetch('/api/sensors'), fetch('/api/scenarios')
            ]);
            const sensors = await sensorsRes.json();
            const scenarios = await scenariosRes.json();

            const sensorSelect = document.getElementById('eventSensorSelect');
            sensorSelect.innerHTML = '<option value="">— Оберіть сенсор —</option>';
            sensors.forEach(s => sensorSelect.add(new Option(`${s.sensorName} (${s.sensorType})`, s.id)));

            const scenarioSelect = document.getElementById('eventScenarioSelect');
            scenarioSelect.innerHTML = '<option value="">— Без сценарію —</option>';
            scenarios.forEach(s => scenarioSelect.add(new Option(`${s.scenarioType} (${s.priority})`, s.id)));
        } catch (err) {
            console.error("Помилка завантаження селектів", err);
        }
    }

    // === Створення сценарію ===
    document.getElementById('createScenarioBtn').addEventListener('click', async () => {
        const data = {
            scenarioType: document.getElementById('scenarioType').value.trim(),
            description: document.getElementById('scenarioDesc').value.trim(),
            priority: document.getElementById('scenarioPriority').value,
            isActive: document.getElementById('scenarioActive').checked
        };

        if (!data.scenarioType) return showMessage('scenarioResult', 'Введіть тип сценарію!', 'warning');

        try {
            const res = await fetch('/api/scenarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!res.ok) throw new Error((await res.json()).message || 'Помилка');

            showMessage('scenarioResult', 'Сценарій створено!', 'success');
            document.getElementById('scenarioType').value = '';
            document.getElementById('scenarioDesc').value = '';
            loadScenarios();
            loadSensorsAndScenariosForSelects();
        } catch (err) {
            showMessage('scenarioResult', err.message, 'error');
        }
    });

    // === Створення івенту ===
    document.getElementById('createEventBtn').addEventListener('click', async () => {
        const data = {
            sensorID: parseInt(document.getElementById('eventSensorSelect').value),
            scenarioID: document.getElementById('eventScenarioSelect').value ? parseInt(document.getElementById('eventScenarioSelect').value) : null,
            description: document.getElementById('eventDesc').value.trim(),
            severity: document.getElementById('eventSeverity').value,
            status: document.getElementById('eventStatus').value
        };

        if (!data.sensorID || !data.description) {
            return showMessage('eventResult', 'Заповніть усі обов’язкові поля!', 'warning');
        }

        try {
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!res.ok) throw new Error('Помилка створення івенту');

            showMessage('eventResult', 'Івент зареєстровано!', 'success');
            document.getElementById('eventDesc').value = '';
            document.getElementById('eventSensorSelect').value = '';
            document.getElementById('eventScenarioSelect').value = '';
            loadEvents();
        } catch (err) {
            showMessage('eventResult', err.message || 'Помилка', 'error');
        }
    });

    // === Вирішити івент ===
    window.resolveEvent = async (id) => {
        if (!confirm('Позначити івент як вирішений?')) return;

        try {
            const res = await fetch(`/api/events/${id}/resolve`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!res.ok) throw new Error('Не вдалося вирішити івент');

            showMessage('eventResult', 'Івент вирішено!', 'success');
            loadEvents();
        } catch (err) {
            alert('Помилка: ' + (err.message || 'невідома'));
        }
    };

    // === Видалення ===
    window.deleteScenario = async (id) => {
        if (!confirm('УВАГА! Видалити сценарій назавжди?')) return;
        try {
            const res = await fetch(`/api/scenarios/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error((await res.json()).message || 'Є пов’язані івенти');
            showMessage('scenarioResult', 'Сценарій видалено!', 'success');
            loadScenarios();
            loadSensorsAndScenariosForSelects();
        } catch (err) {
            alert('Не вдалося видалити: ' + err.message);
        }
    };

    window.deleteEvent = async (id) => {
        if (!confirm('Видалити цей івент?')) return;
        try {
            const res = await fetch(`/api/events/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Не вдалося видалити');
            showMessage('eventResult', 'Івент видалено!', 'success');
            loadEvents();
        } catch (err) {
            alert('Помилка видалення');
        }
    };

    // === Повідомлення ===
    function showMessage(id, text, type) {
        const el = document.getElementById(id);
        el.innerText = text;
        el.style.color = type === 'success' ? '#00ffcc' : type === 'error' ? '#ff5555' : '#ffaa00';
    }

    // Запуск
    document.addEventListener('DOMContentLoaded', loadAllData);
</script>

<style>
    /* Твій старий CSS + нова кнопка */
    .btn-resolve {
        background: #00ff00;
        color: #000;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        margin-right: 8px;
    }

        .btn-resolve:hover {
            background: #00ff88;
        }

    /* Решта стилів залишається без змін */
    /* (твій CSS з попереднього повідомлення) */
    body {
        font-family: 'Segoe UI',sans-serif;
        background: linear-gradient(135deg,#0a0a0a,#0a1a2e);
        color: #fff;
        display: flex;
        justify-content: center;
        padding: 30px 20px;
        min-height: 100vh
    }

    .form-wrapper {
        width: 740px;
        text-align: center
    }

    .form-container {
        background: #0d0d0d;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0,191,255,0.7)
    }

    h2 {
        color: #00bfff;
        margin: 35px 0 20px;
        font-size: 24px
    }

    .entry-box {
        background: rgba(0,191,255,0.08);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #00bfff;
        margin-bottom: 25px
    }

    input, select {
        width: 100%;
        padding: 14px;
        margin: 12px 0;
        background: #0a0a0a;
        border: 1px solid #00bfff;
        border-radius: 8px;
        color: #fff;
        font-size: 16px
    }

    .btn-submit, .btn-login {
        padding: 16px;
        width: 100%;
        margin: 20px 0;
        background: #00bfff;
        color: #000;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        font-size: 17px;
        cursor: pointer;
        transition: .3s
    }

    .btn-login {
        background: #0a0a0a;
        border: 2px solid #00bfff;
        color: #00bfff
    }

        .btn-login:hover, .btn-submit:hover {
            background: #00ffff;
            color: #000
        }

    .items-container {
        max-height: 500px;
        overflow-y: auto;
        padding: 10px
    }

    .item-card {
        background: rgba(0,191,255,0.08);
        padding: 18px;
        margin: 15px 0;
        border-radius: 12px;
        border-left: 5px solid #00bfff;
        position: relative;
        transition: all .3s
    }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(0,191,255,0.4)
        }

        .item-card.resolved {
            opacity: 0.75;
            border-left-color: #00ff00
        }

    .severity-critical {
        border-left-color: #ff0000 !important
    }

    .severity-warning {
        border-left-color: #ffaa00 !important
    }

    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 8px
    }

    .severity-badge, .priority-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold
    }

    .priority-low {
        background: #00ff0033;
        color: #00ff00
    }

    .priority-medium {
        background: #ffaa0033;
        color: #ffaa00
    }

    .priority-high {
        background: #ff550033;
        color: #ff5555
    }

    .priority-critical {
        background: #ff000033;
        color: #ff0000
    }

    .description {
        margin: 10px 0;
        font-size: 15px;
        color: #ccc
    }

    .item-actions {
        position: absolute;
        top: 12px;
        right: 12px
    }

    .btn-delete {
        background: #ff3333;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer
    }

        .btn-delete:hover {
            background: #ff5555
        }

    .status-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: inline-block
    }

        .status-dot.active {
            background: #00ff00;
            box-shadow: 0 0 15px #00ff0088;
            animation: pulse-green 2s infinite ease-in-out
        }

        .status-dot.inactive {
            background: #ff0000;
            box-shadow: 0 0 15px #ff000088;
            animation: pulse-red 2s infinite ease-in-out
        }

    @@keyframes pulse-green {
        0%, 100% {
            box-shadow: 0 0 15px #00ff0088
        }

        50% {
            box-shadow: 0 0 35px #00ff00ee;
            transform: scale(1.3)
        }
    }

    @@keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 15px #ff000088
        }

        50% {
            box-shadow: 0 0 35px #ff0000ee;
            transform: scale(1.3)
        }
    }
</style>