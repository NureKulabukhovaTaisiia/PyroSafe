@page
@model PyroSafe.Pages.User.AddEventAndScenarioModel
@{
    ViewData["Title"] = "Сценарії та Івенти";
}

<div class="form-wrapper">
    <h1 class="welcome-title">Сценарії та Івенти</h1>
    <button type="button" class="btn-login" onclick="location.href='/User/Home'">На головну</button>

    <div class="form-container">

        <!-- СТВОРИТИ СЦЕНАРІЙ -->
        <h2 style="color:#00ffcc;">Створити сценарій</h2>
        <div class="entry-box">
            <input type="text" id="scenarioType" placeholder="Тип (наприклад: Пожежа)" />
            <input type="text" id="scenarioDesc" placeholder="Опис (не обов’язково)" />
            <select id="scenarioPriority">
                <option value="Low">Низький</option>
                <option value="Medium">Середній</option>
                <option value="High">Високий</option>
                <option value="Critical">Критичний</option>
            </select>
            <label><input type="checkbox" id="scenarioActive" checked /> Активний</label>
            <button id="createScenarioBtn" class="btn-submit">Створити сценарій</button>
            <p id="scenarioResult"></p>
        </div>

        <hr />

        <h2>Сценарії</h2>
        <div id="scenariosList" class="items-container">Завантаження...</div>

        <hr />

        <h2 style="color:#ffaa00;">Зареєструвати івент</h2>
        <div class="entry-box">
            <select id="eventSensorSelect"><option>— Оберіть сенсор —</option></select>
            <select id="eventScenarioSelect"><option value="">— Без сценарію —</option></select>
            <input type="text" id="eventDesc" placeholder="Опис івенту" />
            <select id="eventSeverity">
                <option value="Info">Інформація</option>
                <option value="Warning">Попередження</option>
                <option value="Critical">Критична</option>
            </select>
            <select id="eventStatus">
                <option value="Active">Активний</option>
                <option value="Resolved">Вирішений</option>
            </select>
            <button id="createEventBtn" class="btn-submit">Зареєструвати івент</button>
            <p id="eventResult"></p>
        </div>

        <hr />

        <h2>Останні івенти</h2>
        <div id="eventsList" class="items-container">Завантаження...</div>
    </div>
</div>

<script>
    // Безпечне отримання JSON
    async function safeJson(response) {
        if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text || response.statusText}`);
        }
        const text = await response.text();
        if (!text) return null;
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error("Не вдалося розпарсити JSON:", text);
            throw new Error("Сервер повернув некоректний JSON");
        }
    }

    async function loadAllData() {
        await Promise.allSettled([
            loadScenarios(),
            loadEvents(),
            loadSensorsAndScenariosForSelects()
        ]);
    }

    async function loadScenarios() {
        try {
            const res = await fetch('/api/scenarios');
            const data = await safeJson(res);
            const list = document.getElementById('scenariosList');
            if (!data || data.length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center;">Немає сценаріїв</p>';
                return;
            }
            list.innerHTML = data.map(s => `
                <div class="item-card ${s.isActive ? 'active' : 'inactive'}">
                    <div class="item-header">
                        <strong>${s.scenarioType}</strong>
                        <span class="priority-badge priority-${s.priority.toLowerCase()}">${s.priority}</span>
                        <span class="status-dot ${s.isActive ? 'active' : 'inactive'}"></span>
                    </div>
                    <p>${s.description || 'Без опису'}</p>
                    <button class="btn-delete" onclick="deleteScenario(${s.id})">Видалити</button>
                </div>
            `).join('');
        } catch (err) {
            document.getElementById('scenariosList').innerHTML = `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

    async function loadEvents() {
        try {
            const res = await fetch('/api/events');
            const data = await safeJson(res);
            const list = document.getElementById('eventsList');
            if (!data || data.length === 0) {
                list.innerHTML = '<p style="color:#888; text-align:center;">Немає івентів</p>';
                return;
            }
            list.innerHTML = data.map(e => `
                <div class="item-card severity-${e.severity.toLowerCase()} ${e.status === 'Resolved' ? 'resolved' : ''}">
                    <div class="item-header">
                        <strong>Івент #${e.id}</strong>
                        <span class="severity-badge">${e.severity}</span>
                    </div>
                    <p>Сенсор: ${e.sensorID} | Сценарій: ${e.scenarioID || '—'}</p>
                    <p>${e.description}</p>
                    <small>${e.resolvedAt ? 'Вирішено' : 'Активний'}</small>
                    <button class="btn-delete" onclick="deleteEvent(${e.id})">Видалити</button>
                </div>
            `).join('');
        } catch (err) {
            document.getElementById('eventsList').innerHTML = `<p style="color:#ff5555;">Помилка: ${err.message}</p>`;
        }
    }

    async function loadSensorsAndScenariosForSelects() {
        try {
            const [sensorsRes, scenariosRes] = await Promise.all([
                fetch('/api/sensors'), fetch('/api/scenarios')
            ]);
            const sensors = await safeJson(sensorsRes) || [];
            const scenarios = await safeJson(scenariosRes) || [];

            const sensorSelect = document.getElementById('eventSensorSelect');
            sensorSelect.innerHTML = '<option value="">— Оберіть сенсор —</option>';
            sensors.forEach(s => sensorSelect.add(new Option(`${s.sensorName} (${s.sensorType})`, s.id)));

            const scenarioSelect = document.getElementById('eventScenarioSelect');
            scenarios.forEach(s => scenarioSelect.add(new Option(`${s.scenarioType}`, s.id)));
        } catch (err) {
            console.error("Помилка завантаження селектів:", err);
        }
    }

    // Створення сценарію
    document.getElementById('createScenarioBtn').onclick = async () => {
        const data = {
            scenarioType: document.getElementById('scenarioType').value.trim(),
            description: document.getElementById('scenarioDesc').value.trim(),
            priority: document.getElementById('scenarioPriority').value,
            isActive: document.getElementById('scenarioActive').checked
        };
        if (!data.scenarioType) return showMsg('scenarioResult', 'Введіть тип!', '#ffaa00');

        try {
            const res = await fetch('/api/scenarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            await safeJson(res);
            showMsg('scenarioResult', 'Сценарій створено!', '#00ffcc');
            document.getElementById('scenarioType').value = '';
            loadAllData();
        } catch (err) {
            showMsg('scenarioResult', err.message, '#ff5555');
        }
    };

    // Створення івенту
    document.getElementById('createEventBtn').onclick = async () => {
        const data = {
            sensorID: +document.getElementById('eventSensorSelect').value,
            scenarioID: document.getElementById('eventScenarioSelect').value ? +document.getElementById('eventScenarioSelect').value : null,
            description: document.getElementById('eventDesc').value.trim(),
            severity: document.getElementById('eventSeverity').value,
            status: document.getElementById('eventStatus').value
        };
        if (!data.sensorID || !data.description) return showMsg('eventResult', 'Заповніть обов’язкові поля!', '#ffaa00');

        try {
            const res = await fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            await safeJson(res);
            showMsg('eventResult', 'Івент створено!', '#00ffcc');
            document.getElementById('eventDesc').value = '';
            loadEvents();
        } catch (err) {
            showMsg('eventResult', err.message, '#ff5555');
        }
    };

    window.deleteScenario = async (id) => { if (confirm('Видалити сценарій?')) { await fetch(`/api/scenarios/${id}`, { method: 'DELETE' }); loadAllData(); } };
    window.deleteEvent = async (id) => { if (confirm('Видалити івент?')) { await fetch(`/api/events/${id}`, { method: 'DELETE' }); loadEvents(); } };

    function showMsg(id, text, color) {
        const el = document.getElementById(id);
        el.innerHTML = text;
        el.style.color = color;
    }

    // Автовибір сенсора з URL
    const params = new URLSearchParams(location.search);
    const sensorId = params.get('sensorId');
    if (sensorId) {
        setTimeout(() => {
            const select = document.getElementById('eventSensorSelect');
            if (select) select.value = sensorId;
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', loadAllData);
</script>

<style>
    /* Твій гарний стиль — залишаємо без змін */
    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg,#0a0a0a,#0a1a2e);
        color: #fff;
        display: flex;
        justify-content: center;
        padding: 30px;
        min-height: 100vh;
    }

    .form-wrapper {
        width: 760px;
        text-align: center;
    }

    .form-container {
        background: #0d0d0d;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0,191,255,0.7);
    }

    h2 {
        color: #00bfff;
        margin: 30px 0 15px;
    }

    .entry-box {
        background: rgba(0,191,255,0.08);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #00bfff;
    }

    input, select {
        width: 100%;
        padding: 14px;
        margin: 10px 0;
        background: #0a0a0a;
        border: 1px solid #00bfff;
        border-radius: 8px;
        color: #fff;
    }

    .btn-submit {
        padding: 16px;
        width: 100%;
        margin: 20px 0;
        background: #00bfff;
        color: #000;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
    }

        .btn-submit:hover {
            background: #00ffff;
        }

    .btn-login {
        background: #0a0a0a;
        border: 2px solid #00bfff;
        color: #00bfff;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
    }

    .items-container {
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }

    .item-card {
        background: rgba(0,191,255,0.08);
        padding: 18px;
        margin: 15px 0;
        border-radius: 12px;
        border-left: 5px solid #00bfff;
        position: relative;
    }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(0,191,255,0.4);
        }

    .priority-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: bold;
    }

    .priority-low {
        background: #00ff0033;
        color: #00ff00;
    }

    .priority-critical {
        background: #ff000033;
        color: #ff0000;
    }

    .btn-delete {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #ff3333;
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
    }

    .status-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 10px;
    }

        .status-dot.active {
            background: #00ff00;
            animation: pulse-green 2s infinite;
        }

        .status-dot.inactive {
            background: #ff0000;
            animation: pulse-red 2s infinite;
        }

    @@keyframes pulse-green {
        0%, 100% {
            box-shadow: 0 0 15px #00ff0088;
        }

        50% {
            box-shadow: 0 0 35px #00ff00ee;
            transform: scale(1.3);
        }
    }

    @@keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 15px #ff000088;
        }

        50% {
            box-shadow: 0 0 35px #ff0000ee;
            transform: scale(1.3);
        }
    }
</style>