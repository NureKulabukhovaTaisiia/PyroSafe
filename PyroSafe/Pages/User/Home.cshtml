using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.HttpOverrides;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.OpenApi.Models;
using System.Diagnostics;

var builder = WebApplication.CreateBuilder(args);

// ===== BASE DOMAIN =====
var baseDomain = builder.Configuration["BASE_DOMAIN"]
                 ?? "http://localhost:7080";

// ===== PostgreSQL =====
builder.Services.AddDbContext<AppDbContext>
    (options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("PostgreSqlConnection")));

    // ===== CORS =====
    builder.Services.AddCors(options =>
    {
    options.AddPolicy("AllowApp", policy =>
    {
    policy.AllowAnyOrigin()
    .AllowAnyHeader()
    .AllowAnyMethod();
    });
    });

    // ===== Controllers & Razor Pages =====
    builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
    options.JsonSerializerOptions.PropertyNamingPolicy =
    System.Text.Json.JsonNamingPolicy.CamelCase;
    options.JsonSerializerOptions.DefaultIgnoreCondition =
    System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull;
    options.JsonSerializerOptions.PropertyNameCaseInsensitive = true;
    });
    builder.Services.AddRazorPages();

    // ===== Session =====
    builder.Services.AddDistributedMemoryCache();
    builder.Services.AddSession(options =>
    {
    options.IdleTimeout = TimeSpan.FromHours(1);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
    options.Cookie.SameSite = SameSiteMode.Lax;
    });

    // ===== Authentication =====
    builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
    options.LoginPath = "/Account/Login";
    options.LogoutPath = "/Account/Logout";
    options.ExpireTimeSpan = TimeSpan.FromHours(12);
    options.SlidingExpiration = true;
    options.Cookie.HttpOnly = true;
    options.Cookie.SameSite = SameSiteMode.Lax;
    });

    builder.Services.AddAuthorization();

    // ===== HttpContextAccessor =====
    builder.Services.AddHttpContextAccessor();

    // ===== Swagger =====
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen(c =>
    {
    c.SwaggerDoc("v1", new OpenApiInfo
    {
    Title = "PyroSafe API",
    Version = "v1"
    });
    });

    // ===== Forwarded Headers (Render) =====
    builder.Services.Configure<ForwardedHeadersOptions>
        (options =>
        {
        options.ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;
        options.KnownNetworks.Clear();
        options.KnownProxies.Clear();
        });

        // ========== Build ==========
        var app = builder.Build();

        app.UseForwardedHeaders();

        app.UseHttpsRedirection();
        app.UseStaticFiles();
        app.UseRouting();
        app.UseCors("AllowApp");
        app.UseSession();

        // ===== ДОЗВОЛЯЄМО SWAGGER БЕЗ АВТОРИЗАЦІЇ =====
        app.Use(async (context, next) =>
        {
        var path = context.Request.Path.Value?.ToLower();

        if (path != null && (path.StartsWith("/swagger") || path.StartsWith("/swagger/index.html")))
        {
        // Пропускаємо swagger без авторизації
        context.Items["AllowAnonymous"] = true;
        await next();
        return;
        }

        await next();
        });

        // ===== Authentication / Authorization =====
        app.Use(async (context, next) =>
        {
        // Якщо стоїть прапор AllowAnonymous → пропускаємо без перевірки
        if (context.Items.ContainsKey("AllowAnonymous"))
        {
        await next();
        return;
        }

        await next();
        });

        app.UseAuthentication();
        app.UseAuthorization();

        app.UseSwagger();
        app.UseSwaggerUI();

        app.MapControllers();
        app.MapRazorPages();


        // Swagger тільки в деві
        if (app.Environment.IsDevelopment())
        {
        app.UseSwagger();
        app.UseSwaggerUI();
        }

        // Автовідкриття (локально)
        if (app.Environment.IsDevelopment())
        {
        try
        {
        Process.Start(new ProcessStartInfo
        {
        FileName = "https://pyrosafe-o880.onrender.com/Account/Register",
        UseShellExecute = true
        });
        }
        catch { }
        }

        app.Run();
